<!doctype html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sonic 3 A.I.R.</title>
<link rel="apple-touch-icon" sizes="256x256" href="icon.png">
<link rel="icon" type="x-icon" href="icon.png">
<link rel="manifest" href="manifest.json">
<style>
body {
  background: black;
  color: white;
  font-family: arial;
  margin: 0;
  padding: none;
  overflow: hidden;
  -webkit-user-select: none;
}
.emscripten {
  padding-right: 0;
  margin-left: auto;
  margin-right: auto;
  display: block;
}
div.emscripten { text-align: center; }
div.emscripten_border { border: 0 none; }
canvas.emscripten {
  border: 0 none;
  background-color: #000;
}
.spinner {
  height: 30px;
  width: 30px;
  margin: 0;
  margin-top: 20px;
  margin-left: 20px;
  display: inline-block;
  vertical-align: top;
  animation: rotation .8s linear infinite;
  border-left: 5px solid #ebebeb;
  border-right: 5px solid #ebebeb;
  border-bottom: 5px solid #ebebeb;
  border-top: 5px solid #787878;
  border-radius: 100%;
  background-color: #bdd72e;
}
@keyframes rotation {
  from { transform: rotate(0); }
  to { transform: rotate(360deg); }
}
#status {
  display: inline-block;
  vertical-align: top;
  margin-top: 30px;
  margin-left: 20px;
  font-size: 1em;
  font-weight: 700;
  color: #787878;
}
#progress { height: 20px; width: 250px; }
.hidden { display: none !important; }

.file_select { text-align: center; font-size: 0.9em; }
input[type="file"] { display: none; }
.fileSelector {
  display: inline-block;
  background: linear-gradient(0deg, #111 0%, #444 100%);
  border: 1px solid #999;
  border-radius: 5px;
  margin-top: 3px;
  padding: 5px 8px;
  cursor: pointer;
  text-shadow: 1px 1px #555;
  font-size: 32px;
}
.fileSelector:hover { border-color: black; }
.fileSelector:active { background: linear-gradient(0deg, #333 0%, #555 100%); }

.restart { text-align: center; font-size: 1em; }
.extraDownloads { display: inline-block; }
.restart > button,
.extraDownloads > button,
.extraDownloadsSection > button {
  display: inline-block;
  color: white;
  background: linear-gradient(0deg, #111 0%, #444 100%);
  border: 1px solid #999;
  border-radius: 5px;
  margin-top: 3px;
  padding: 5px 8px;
  cursor: pointer;
  text-shadow: 1px 1px #555;
  font-size: 32px;
}
.extraDownloadsSection { text-align: center; }
.extraDownloadsProgress { text-align: center; font-size: 0.9em; }
#root { color: black; }
#ios_workaround {
  width: 100%;
  height: 100%;
  position: flex;
  top: 0;
  left: 0;
  text-align: center;
  padding-top: 40vh;
  font-size: 2em;
  user-select: none;
  cursor: default;
  background-color: rgba(0,0,0,50%);
}
</style>

<script src="browserfs.min.js"></script>
<script>
var hasRemasteredAudio = false;

function startGame(){
  callMain();
  var gameCanvas = document.getElementById('canvas');
  gameCanvas.style.width = "min(100vw, calc(100vh * 16 / 9))";
  gameCanvas.style.height = "min(100vh, calc(100vw * 9 / 16))";
  gameCanvas.style.marginTop = "max(0vh, calc(50vh - (100vw * 9 / 16 / 2)))";

  if(isRunningOniOS()){
    let iosoverlay = document.getElementById('ios_workaround');
    if(iosoverlay){
      iosoverlay.classList.remove('hidden');
    }
  }
}

function isRunningOniOS() {
  return [
    'iPad Simulator','iPhone Simulator','iPod Simulator',
    'iPad','iPhone','iPod'
  ].includes(navigator.platform)
  || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
}

function hideIOSoverlay(){
  let iosoverlay = document.getElementById('ios_workaround');
  if(iosoverlay){
    document.body.removeChild(iosoverlay);
  }
}

function onPageLoaded(){
  if('serviceWorker' in navigator) {
    navigator.serviceWorker.register('worker.js');
  }
  document.getElementById("startup").style.display = 'none';
  document.querySelectorAll('.pageUI').forEach(e => e.classList.remove('hidden'));

  var loader=document.createElement('script');
  loader.async = true;
  loader.src = 'loader.js';
  document.body.appendChild(loader);
  Module['calledRun'] = true;

  if(!isRunningOniOS()) hideIOSoverlay();
}

function onGameExit(){
  document.querySelectorAll('.restart').forEach(e=>e.classList.remove('hidden'));
  if(!hasRemasteredAudio){
    document.querySelectorAll('.extraDownloads').forEach(e=>e.classList.remove('hidden'));
  }
  document.getElementById("gameView").classList.add('hidden');
  document.getElementById("root").classList.remove('hidden');

  ['fileManagerRuntime.js','react.js','filemanager.js'].forEach(js=>{
    var s=document.createElement('script'); s.src=js; document.body.appendChild(s);
  });

  exitRuntime();
}

function onDownloadsComplete(){
  var originalAbort = abort;
  abort = function(what){
    if(what.stack.indexOf('browserfs')>0){ what.errno = 44; return; }
    originalAbort(what);
  }

  var BFS = new BrowserFS.EmscriptenFS(Module.FS, Module.PATH, Module.ERRNO_CODES);
  FS.mount(BFS, {root: '/'}, '/sonic3air/savedata/');
  FS.chdir("/sonic3air");
  hasRemasteredAudio = FS.analyzePath("/sonic3air/savedata/audioremaster.bin", true).exists;
  if(hasRemasteredAudio){
    FS.symlink('/sonic3air/savedata/audioremaster.bin','/sonic3air/data/audioremaster.bin');
  }

  if(FS.analyzePath("/sonic3air/savedata/Sonic_Knuckles_wSonic3.bin", true).exists){
    if(!FS.analyzePath("/sonic3air/___internal/").exists){
      FS.mkdir('/sonic3air/___internal/');
    }
    hidePageUI();
    startGame();
  } else {
    document.querySelectorAll('.file_select').forEach(e=>e.classList.remove('hidden'));
  }
}

function hidePageUI(){
  var el = document.querySelector('.file_select');
  if(el) el.remove();
  document.querySelectorAll('.pageUI').forEach(e=>e.style.display='none');
}

function installS3kFile(fileInput){
  if(fileInput.files.length==0) return;
  var file=fileInput.files[0];
  var fr=new FileReader();
  fr.onload=function(){
    var data=new Uint8Array(fr.result);
    if(data.length!=4194304 || data[0x186]!=0x31 || data[0x187]!=0x35 || data[0x188]!=0x36 || data[0x189]!=0x33){
      document.getElementById("s3kPromptMessage").innerText="The selected file was not Sonic 3 and Knuckles. Try again:";
      return;
    }
    Module['FS_createDataFile']('/sonic3air/savedata/','Sonic_Knuckles_wSonic3.bin',data,true,true,true);
    hidePageUI();
    startGame();
  };
  fr.readAsArrayBuffer(file);
}
</script>
</head>
<body>
<div id="startup"><h2>Loading...</h2></div>
<div class="spinner pageUI hidden" id="spinner"></div>
<div class="emscripten pageUI hidden" id="status">Downloading...</div>
<div class="emscripten pageUI hidden"><progress hidden id="progress" max="100" value="0"></progress></div>

<div class="file_select hidden">
  <span>To run the game, Sonic 3 A.I.R. requires an original copy of the Sonic 3 & Knuckles ROM.</span><br/>
  <span id="s3kPromptMessage">Please select your ROM file:</span><br/>
  <label for="fileSelector" class="fileSelector">Select File...</label>
  <input id="fileSelector" class="fileSelector" type="file" onChange="installS3kFile(this);" />
</div>

<div class="restart hidden">
  <button type="button" onclick="location.reload()">Restart Game</button>
  <div class="extraDownloads hidden">
    <button type="button" onclick="showExtraDownloads()">Extra Downloads</button> 
  </div>
</div>

<div class="extraDownloadsSection hidden">
  <div style="margin:1em;">On other platforms, Sonic 3 A.I.R. includes remastered music which is enabled by default.
  Installing this may reduce stability on low-memory devices.</div>
  <br/>
  <button type="button" onclick="hideExtraDownloads()">Go Back</button> 
  <br/>
  <button type="button" onclick="downloadRemastered()">Install Anyway</button>
</div>

<div class="extraDownloadsProgress hidden">
  <div id="extraStatus">Downloading...</div>
  <div><progress id="extraProgress" max="100" value="0"></progress></div>
</div>

<div id="root" class="hidden"></div>
<div id="gameView" class="emscripten_border">
  <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
</div>

<div id="ios_workaround" class="hidden" onclick="hideIOSoverlay()">Tap to Start</div>

<script>
var statusElement=document.getElementById("status"),
progressElement=document.getElementById("progress"),
spinnerElement=document.getElementById("spinner");

var Module={
  preRun:function(){ onPageLoaded(); },
  postRun:[],
  onExit:function(){ onGameExit(); },
  noInitialRun:true,
  printErr:function(e){ console.error(e); },
  canvas:(function(){
    var e=document.getElementById("canvas");
    e.addEventListener("webglcontextlost",function(ev){
      alert("WebGL context lost. Please reload the page."); ev.preventDefault();
    },false);
    return e;
  })(),
  setStatus:function(e){
    if(!this.setStatus.last){this.setStatus.last={time:Date.now(),text:""};}
    if(e!==this.setStatus.last.text){
      var t=e.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/),n=Date.now();
      if(!t||n-this.setStatus.last.time>=30){
        this.setStatus.last.time=n; this.setStatus.last.text=e;
        if(t){
          e=t[1];
          progressElement.value=100*parseInt(t[2]);
          progressElement.max=100*parseInt(t[4]);
          progressElement.hidden=false;
          spinnerElement.hidden=false;
        } else {
          progressElement.value=null; progressElement.max=null; progressElement.hidden=true;
          if(!e) spinnerElement.style.display="none";
        }
        statusElement.innerHTML=e;
      }
    }
  },
  totalDependencies:0,
  monitorRunDependencies:function(e){
    this.totalDependencies=Math.max(this.totalDependencies,e);
    Module.setStatus(e?"Preparing... ("+(this.totalDependencies-e)+"/"+this.totalDependencies+")":"All downloads complete.");
    if(!e){
      if(FS.analyzePath("/sonic3air/config.json",true).exists){
        FS.mkdir('/sonic3air/savedata');
        BrowserFS.configure({
          fs:"AsyncMirror",
          options:{
            sync:{fs:"InMemory"},
            async:{fs:"IndexedDB",options:{storeName:"sonic3air_savedata"}}
          }
        },function(err){
          if(err) throw err;
          onDownloadsComplete();
        });
      }
    }
  }
};
Module.setStatus("Downloading...");
window.onerror=function(e){
  Module.setStatus("Exception thrown, see console");
  spinnerElement.style.display="none";
  Module.setStatus=function(e){ e&&Module.printErr("[post-exception status] "+e); }
};
</script>
<script async src="sonic3air_web.js"></script>
</body>
</html>
